<h1>All available Volunteer Opportunities</h1>

<div class="appointments"></div>

<script id="appointment-template" type="text/x-handlebars-template">
  <div class="appointment-content">
    <h2>{{title}}</h2>
    <h4>{{info}}</h4>
    <div class="appointment-data">
      from post: <a href="/posts/{{post.id}}">{{post.title}}</a>, <a href="/users/{{owner_id}}">{{owner_name}}</a>'s profile 
    </div>
    <input type="submit" value="More Info" class="more-info-button" data-id={{availableId}} />
  </div>
</script>
<script id="full-appointment-template" type="text/x-handlebars-template">
  <div class="appointment-content">
    <h2>{{title}}</h2>
    <h4>{{info}}</h4>
    <div class="appointment-data">
      <p>There are {{spots_left}} available spots for this opportunity</p>
      <p>Start Date: {{start_date}}</p>
      <p>End Date: {{end_date}}</p>
      <p>from post: <a href="/posts/{{post.id}}">{{post.title}}</a></p>
      <p>created by user: <a href="/users/{{owner_id}}">{{owner_name}}</a></p>
      <p>would you like to sign up to volunteer for this opportunity?</p>
      <form action="/appointments/{{id}}" method="get" class="volunteer-button">
        <input type="submit" value="Volunteer!" />
      </form>
    </div>
    <input type="submit" value="Next Volunteer Opportunity" id="next-info-button"/>
    <input type="submit" value="Last Volunteer Opportunity" id="last-info-button"/>
    <input type="submit" value="All Volunteer Opportunities" id="all-info-button"/>
  </div>
</script>

<% content_for :js do %>
  <script>
    class Appointment {
      constructor(attributes = {}) {
        this.post = attributes.post
        this.id = attributes.id
        this.title = attributes.title
        this.spots_left = attributes.spots_left
        this.info = attributes.info
        this.start_date = attributes.start_date
        this.end_date = attributes.end_date
        this.owner_id = attributes.owner_id
        this.owner_name = attributes.owner_name
        this.availableId = Appointment.allAppointments.length
        Appointment.allAppointments.push(this)
      }
      renderAppointment() {
        return Appointment.template(this)
      }
      renderFullApp(){
        return Appointment.fullTemplate(this)
      }
    }
    Appointment.getAppointments = function(){
      $.ajax({
        dataType: "JSON",
        url: '/appointments/available',
        method: "get"
      }).success((appointments) => {
        Appointment.createAppointments(appointments)
        Appointment.renderAppointments()
      })
    }
    Appointment.createAppointments = function(appointments){
      appointments.forEach((a) => {new Appointment(a)})
    }
    Appointment.renderAppointments = function(){
      this.appointmentsDiv.empty()
      this.allAppointments.forEach((a) => {
        this.appointmentsDiv.append(a.renderAppointment())
      })
      this.attachMoreInfoListeners()
    }
    Appointment.attachMoreInfoListeners = function(){
      $(".more-info-button").click(function() {
        console.log(this.dataset.id)
        Appointment.renderAppointmentById(this.dataset.id)
      })
    }
    Appointment.renderAppointmentById = function(id){
      Appointment.appointmentsDiv.html(Appointment.allAppointments[id].renderFullApp())
      Appointment.attachNLAButtons(id)
    }
    Appointment.attachNLAButtons = function(id){
      let appId = parseInt(id)
      $("#next-info-button").click(() => {this.renderAppointmentById(appId + 1)})
      $("#last-info-button").click(() => {this.renderAppointmentById(appId - 1)})
      $("#all-info-button").click(() => {this.renderAppointments()})
    }
    Appointment.renderTemplates = function(){
      this.template = Handlebars.compile(document.getElementById("appointment-template").innerHTML)
      this.fullTemplate = Handlebars.compile(document.getElementById("full-appointment-template").innerHTML)
    }
    Appointment.renderAttributes = function(){
      this.appointmentsDiv = $('.appointments')
      this.userID = $(".user-link").attr("href").slice(-1)
      this.allAppointments = []
    }
    $(
      function() {
        Appointment.renderTemplates()
        Appointment.renderAttributes()
        Appointment.getAppointments()
      }
    )
  </script>
<% end %>